name: Reusable Spring Boot Docker CI

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      registry_url:
        required: true
        type: string
      dockerfile:
        required: true
        type: string
      image_tag:
        required: false
        type: string
        default: "latest"
      compose_file:
        required: true
        type: string
    secrets:
      DOCKER_REGISTRY_USERNAME:
        required: true
      DOCKER_REGISTRY_PASSWORD:
        required: true

jobs:
  build-and-push:
    runs-on: self-hosted

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: 'gradle'

      - name: Grant execute permission for gradlew (if Gradle project)
        if: hashFiles('gradlew') != ''
        run: chmod +x ./gradlew

      - name: Build Spring Boot jar (Gradle)
        if: hashFiles('build.gradle*') != ''
        run: ./gradlew clean bootJar

      - name: Docker login to private registry
        run: |
          echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | \
          docker login ${{ inputs.registry_url }} \
            -u "${{ secrets.DOCKER_REGISTRY_USERNAME }}" --password-stdin

      - name: Build Docker image
        env:
          IMAGE: ${{ inputs.registry_url }}/${{ inputs.service_name }}:${{ inputs.image_tag }}
        run: |
          echo "Building image: $IMAGE"
          docker build -t "$IMAGE" -f "${{ inputs.dockerfile }}" .

      - name: Push Docker image
        env:
          IMAGE: ${{ inputs.registry_url }}/${{ inputs.service_name }}:${{ inputs.image_tag }}
        run: |
          echo "Pushing image: $IMAGE"
          docker push "$IMAGE"

  deploy:
    runs-on: self-hosted
    needs: build-and-push

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Docker login to private registry
        run: |
          echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | \
          docker login ${{ inputs.registry_url }} \
            -u "${{ secrets.DOCKER_REGISTRY_USERNAME }}" --password-stdin

      - name: Docker Compose pull & up
        env:
          IMAGE: ${{ inputs.registry_url }}/${{ inputs.service_name }}:${{ inputs.image_tag }}
        run: |
          echo "Using image: $IMAGE"
          echo "Compose file: ${{ inputs.compose_file }}"
          docker compose -f "${{ inputs.compose_file }}" pull
          docker compose -f "${{ inputs.compose_file }}" up -d

      - name: Cleanup old images
        run: docker image prune -f